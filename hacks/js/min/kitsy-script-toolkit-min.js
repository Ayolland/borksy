function inject(t,e){var i=kitsyInit(),n=[].slice.call(arguments);e=flatten(n.slice(1)),i.queuedInjectScripts.push({searchString:t,codeFragments:e})}function before(t,e){var i=kitsyInit();i.queuedBeforeScripts[t]=i.queuedBeforeScripts[t]||[],i.queuedBeforeScripts[t].push(e)}function after(t,e){var i=kitsyInit();i.queuedAfterScripts[t]=i.queuedAfterScripts[t]||[],i.queuedAfterScripts[t].push(e)}function kitsyInit(){if(bitsy.kitsy)return bitsy.kitsy;bitsy.kitsy={queuedInjectScripts:[],queuedBeforeScripts:{},queuedAfterScripts:{}};var t=bitsy.startExportedGame;return bitsy.startExportedGame=function e(){bitsy.startExportedGame=t,doInjects(),applyAllHooks(),bitsy.startExportedGame.apply(this,arguments)},bitsy.kitsy}function doInjects(){bitsy.kitsy.queuedInjectScripts.forEach(function(t){utilsInject(t.searchString,t.codeFragments)}),_reinitEngine()}function applyAllHooks(){unique(Object.keys(bitsy.kitsy.queuedBeforeScripts).concat(Object.keys(bitsy.kitsy.queuedAfterScripts))).forEach(applyHook)}function applyHook(t){var e=bitsy[t],i=e.length,n=[];n=n.concat(bitsy.kitsy.queuedBeforeScripts[t]||[]),n.push(e),n=n.concat(bitsy.kitsy.queuedAfterScripts[t]||[]),bitsy[t]=function(){function t(){if(r!==n.length)if(arguments.length>0&&(e=[].slice.call(arguments)),n[r].length>i)n[r++].apply(this,e.concat(t.bind(this)));else{var s=n[r++].apply(this,e)||e;t.apply(this,s)}}var e=[].slice.call(arguments),r=0;t.apply(this,arguments)}}function _reinitEngine(){bitsy.scriptModule=new bitsy.Script,bitsy.scriptInterpreter=bitsy.scriptModule.CreateInterpreter(),bitsy.dialogModule=new bitsy.Dialog,bitsy.dialogRenderer=bitsy.dialogModule.CreateRenderer(),bitsy.dialogBuffer=bitsy.dialogModule.CreateBuffer()}function addDialogFunction(t,e){var i=kitsyInit();if(i.dialogFunctions=i.dialogFunctions||{},i.dialogFunctions[t])throw new Error('The dialog function "'+t+'" already exists.');before("load_game",function(e,i){return[e.replace(new RegExp("(^|[^\\\\])\\(("+t+' ".+?")\\)',"g"),"$1{$2}").replace(new RegExp("\\\\\\(("+t+' ".+")\\\\?\\)',"g"),"($1)"),i]}),i.dialogFunctions[t]=e}function addDialogTag(t,e){addDialogFunction(t,e),inject("var functionMap = new Map();",'functionMap.set("'+t+'", kitsy.dialogFunctions.'+t+");")}function addDeferredDialogTag(t,e){addDialogFunction(t,e),bitsy.kitsy.deferredDialogFunctions=bitsy.kitsy.deferredDialogFunctions||{};var i=bitsy.kitsy.deferredDialogFunctions[t]=[];inject("var functionMap = new Map();",'functionMap.set("'+t+'", function(e, p, o){ kitsy.deferredDialogFunctions.'+t+".push({e:e,p:p}); o(null); });"),after("onExitDialog",function(){for(;i.length;){var t=i.shift();e(t.e,t.p,t.o)}}),after("clearGameData",function(){i.length=0})}function utilsInject(t,e){var i=[].slice.call(arguments);e=flatten(i.slice(1)).join("");for(var n=document.getElementsByTagName("script"),r,s,o=0;o<n.length;++o){r=n[o];var a=-1!==r.textContent.indexOf(t),c=r===document.currentScript;if(a&&!c){s=r.textContent;break}}if(!s)throw"Couldn't find \""+t+'" in script tags';s=s.replace(t,t+e);var u=document.createElement("script");u.textContent=s,r.insertAdjacentElement("afterend",u),r.remove()}