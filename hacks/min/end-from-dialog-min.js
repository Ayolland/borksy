var queuedEndingNarration=null;before("load_game",function(n,e){return[n.replace(/(^|[^\\])\(((end|endNow)( ".+?")?)\)/g,"$1{$2}").replace(/(^|\\)\(((end|endNow)( ".+?")?)\\?\)/g,"($2)"),e]}),after("clearGameData",function(){queuedEndingNarration=null}),after("onExitDialog",function(){!bitsy.isEnding&&queuedEndingNarration&&bitsy.startNarrating(!0===queuedEndingNarration?null:queuedEndingNarration,!0)}),bitsy.endFunc=function(n,e,i){queuedEndingNarration=e||!0,i(null)},bitsy.endNowFunc=function(n,e,i){bitsy.endFunc.call(this,n,e,function(){}),bitsy.dialogBuffer.EndDialog(),bitsy.onExitDialog()},inject("var functionMap = new Map();",'functionMap.set("end", endFunc);','functionMap.set("endNow", endNowFunc);');