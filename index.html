<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1">
		<meta name="author" content="name">
		<meta name="description" content="description here">
		<meta name="keywords" content="keywords,here">
		<!-- <link rel="shortcut icon" href="favicon.gif"> -->
		<!-- <link rel="stylesheet" href="style.css" type="text/css"> -->
		<style>
			form *{
				display: block;
			}
		</style>
		<title>title</title>
	</head>
	<body>
		<form>
			<label>
				<str>Title:</str>
				This is what the title of your page (not game) will be:
				<textarea data-cookie data-borksy-replace-single="TITLE" rows="4" cols="50" wrap="hard" name="title" id="title">My Bitsy Game By Me</textarea>
			</label>
			<label>
				<str>Game-Data:</str>
				This is the gamedata from Bitsy:
				<textarea data-cookie data-borksy-replace-single="GAMEDATA" data-default="gamedata.txt" rows="4" cols="50" wrap="hard" name="gamedata" id="gamedata"></textarea>
			</label>
			<label>
				<str>CSS:</str>
				This is the CSS for your page:
				<textarea data-cookie data-borksy-replace-single="CSS" data-default="style.css" rows="4" cols="50" wrap="hard" name="css" id="css"></textarea>
			</label>

			<label>
				<str>Font-Data:</str>
				This is the data for your game's font:
				<textarea data-cookie data-borksy-replace-single="FONTDATA" data-default="fontdata.txt" rows="4" cols="50" wrap="hard" name="fontdata" id="fontdata"></textarea>
			</label>

			<label>
				<str>Markup:</str>
				This is the HTML content of your game's body tag:
				<textarea data-cookie data-borksy-replace-single="MARKUP" data-default="body.html" rows="4" cols="50" wrap="hard" name="markup" id="markup"></textarea>
			</label>

			<label>
				<str>Hacks:</str>
				This is JS loaded into a script tag after all Bitsy code
				<textarea data-cookie data-borksy-replace-single="HACKS" rows="4" cols="50" wrap="hard" name="hacks" id="hacks"></textarea>
			</label>

		</form>

		<button id="download-button">Download File</button>
	
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" type="text/javascript"></script>

		<script>
			var loadedFiles ={};

			function loadDefaults(){
				$('[data-default]').each(function(){
					var $this = $(this);
					var filename = $this.data('default');
					var path = 'defaults/' + filename;
					var $ajax = $.ajax(path)
					$ajax.done(function(){
						var response = $ajax.responseText
						$this.val(response);
						loadedFiles[filename] = response;
					});
					$ajax.fail(function(){
						$this.val('failed to load default!');
						console.log($ajax.error);
					})
				});
			}

			function loadTemplate(){
				var $ajax = $.ajax('template/template.html');
				$ajax.done(function(){
					loadedFiles['template.html'] = $ajax.responseText;
				})
			}

			function assembleAndDownloadFile(){
				var modifiedTemplate = loadedFiles['template.html'].repeat(1);
				$('[data-borksy-replace-single]').each(function(){
					var $this = $(this);
					var valueToReplace = 'BORKSY-' + $this.data('borksy-replace-single');
					var formValue = $this.val();
					modifiedTemplate = modifiedTemplate.replace(valueToReplace, formValue)
				});
				$('[data-borksy-replace-single]').promise().done(function(){
					download('myBORKSYgame.html', modifiedTemplate);
				});
			}

			function download(filename, text) {
			    var element = document.createElement('a');
			    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
			    element.setAttribute('download', filename);
			
			    element.style.display = 'none';
			    document.body.appendChild(element);
			
			    element.click();
			
			    document.body.removeChild(element);
			}

			function getCookie(name){
  				var re = new RegExp(name + "=([^;]+)");
  				var value = re.exec(document.cookie);
  				return (value != null) ? unescape(value[1]) : null;
  			}

  			function setCookie(name, value){
  				var today = new Date();
				var expiry = new Date(today.getTime() + 30 * 24 * 3600 * 1000); // plus 30 days
  				document.cookie=name + "=" + escape(value) + "; path=/; expires=" + expiry.toGMTString();
			}

  			function deleteCookie(name){
  				var expired = new Date(today.getTime() - 24 * 3600 * 1000); // less 24 hours
  				document.cookie=name + "=null; path=/; expires=" + expired.toGMTString();
  			}

			function assembleCookie(){

			}
			
			$(document).ready(function(){
				loadTemplate();
				loadDefaults();
				$('#download-button').click(assembleAndDownloadFile);
			});

		</script>
	</body>
</html>